<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Martoo AI Assistant</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <style>
    /* [Same styles as before ‚Äî unchanged] */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('full-site-background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
      overflow-x: hidden;
    }
    header { /* unchanged */ ... }
    .hamburger { ... }
    nav ul { ... }
    nav ul.show { ... }
    nav ul li a { ... }
    nav ul li a:hover { ... }
    .chat-container { ... }
    .chat-box { ... }
    .chat-box p { ... }
    .user { color: #ffcc00; }
    .ai { color: #00ffcc; font-weight: bold; }
    .chat-input { ... }
    input[type="text"], input[type="file"] { ... }
    button { ... }
    footer { ... }
    @media (max-width: 480px) { ... }
    #preview-img { ... }

    #login-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      text-align: center;
    }
    .login-box {
      background: #111;
      padding: 30px;
      border-radius: 15px;
      max-width: 350px;
      box-shadow: 0 0 20px #00ffcc;
    }
    .login-box h2 {
      color: #00ffcc;
      margin-bottom: 20px;
    }
    .login-box input {
      width: 90%;
      margin: 10px auto;
      padding: 10px;
      border: none;
      border-radius: 6px;
    }
    .login-box button {
      width: 95%;
      margin-top: 10px;
      padding: 12px;
      background: #00bfff;
    }
  </style>
</head>
<body>
  <header>
    <h1>Martoo AI Assistant</h1>
    <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
    <nav>
      <ul id="menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="posts.html">Blog</a></li>
        <li><a href="services.html">Services</a></li>
        <li><a href="typing_assistant.html">Typing Assistant</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="downloader.html">Downloader</a></li>
      </ul>
    </nav>
  </header>

  <div class="chat-container">
    <div class="chat-box" id="chat-box"></div>
    <div class="chat-input">
      <input type="text" id="user-input" placeholder="Ask Martoo AI anything..." autocomplete="off"/>
      <input type="file" id="file-input" accept="image/*" />
      <button onclick="sendMessage()">Send</button>
      <button onclick="startDictation()"><i class="fas fa-microphone"></i></button>
    </div>
    <img id="preview-img" />
  </div>

  <footer>&copy; 2024‚Äì2025 | Martoo Tech Works. All rights reserved.</footer>

  <div id="login-overlay">
    <div class="login-box">
      <h2>You've hit the chat limit</h2>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="emailLogin()">Login with Email</button>
      <button onclick="googleLogin()">Login with Google</button>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const chatBox = document.getElementById("chat-box");
    let messageCount = parseInt(localStorage.getItem("martooMsgCount")) || 0;

    function toggleMenu() {
      document.getElementById("menu").classList.toggle("show");
    }

    window.onload = () => {
      const saved = localStorage.getItem("martooChat");
      if (saved) chatBox.innerHTML = saved;
      else chatBox.innerHTML = `<p><span class="ai">Martoo AI:</span> Hello üëã I‚Äôm here to help. Ask me anything!</p>`;
    };

    document.querySelectorAll("nav ul li a").forEach(link => {
      link.addEventListener("click", () => document.getElementById("menu").classList.remove("show"));
    });

    document.getElementById("user-input").addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    document.getElementById("file-input").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => document.getElementById("preview-img").src = e.target.result;
        reader.readAsDataURL(file);
      }
    });

    async function sendMessage() {
      const input = document.getElementById("user-input");
      const message = input.value.trim();
      if (!message) return;

      // Enforce message limit before login
      const user = auth.currentUser;
      if (!user && messageCount >= 5) {
        document.getElementById("login-overlay").style.display = "flex";
        return;
      }

      const userMessage = document.createElement("p");
      userMessage.innerHTML = `<span class="user">You:</span> ${message}`;
      chatBox.appendChild(userMessage);

      const loading = document.createElement("p");
      loading.innerHTML = `<span class="ai">Martoo AI:</span> <em>Typing...</em>`;
      chatBox.appendChild(loading);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const res = await fetch("https://martoo-tech-backend.vercel.app/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await res.json();
        loading.innerHTML = `<span class="ai">Martoo AI:</span> ***${data.reply || "‚ö†Ô∏è No response."}***`;
        input.value = "";

        if (!user) {
          messageCount += 1;
          localStorage.setItem("martooMsgCount", messageCount);
        }
      } catch (err) {
        console.error(err);
        loading.innerHTML = `<span class="ai">Martoo AI:</span> ‚ö†Ô∏è Error connecting to server.`;
      }

      chatBox.scrollTop = chatBox.scrollHeight;
      localStorage.setItem("martooChat", chatBox.innerHTML);
    }

    function startDictation() {
      if (!('webkitSpeechRecognition' in window)) return alert("Speech recognition not supported.");
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onresult = e => {
        document.getElementById("user-input").value = e.results[0][0].transcript;
        sendMessage();
      };
      recognition.onerror = e => alert("Speech error: " + e.error);
      recognition.start();
    }

    // Firebase Auth: Login functions
    function emailLogin() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
          document.getElementById("login-overlay").style.display = "none";
        }).catch(err => alert("Login failed: " + err.message));
    }

    function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).then(() => {
        document.getElementById("login-overlay").style.display = "none";
      }).catch(err => alert("Google login failed: " + err.message));
    }
  </script>
</body>
</html>
