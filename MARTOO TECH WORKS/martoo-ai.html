<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Martoo AI Assistant</title>
  <!-- Inter font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Configure Tailwind to use 'Inter' font -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <!-- Firebase Modular SDK imports -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      signInAnonymously, 
      signInWithCustomToken, 
      onAuthStateChanged, 
      signInWithEmailAndPassword, 
      GoogleAuthProvider, 
      signInWithPopup 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      query, 
      orderBy, // Note: orderBy can require indexes in Firestore, but for simple client-side sorting, we'll fetch and sort in memory if needed.
      addDoc, 
      onSnapshot, 
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables from the Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Make Firebase instances and core variables globally accessible
    window.app = app;
    window.auth = auth;
    window.db = db;
    window.appId = appId;
    window.initialAuthToken = initialAuthToken;

    // State variables
    window.loggedIn = false;
    window.chatCount = 0;
    window.userId = null; // Will be set after authentication

    // Custom message display function (replaces alert())
    window.showMessage = (message, type = 'info') => {
      const messageBox = document.getElementById('message-box');
      if (messageBox) {
        messageBox.textContent = message;
        messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-transform duration-300 transform translate-x-0`;
        if (type === 'error') {
          messageBox.classList.add('bg-red-600', 'text-white');
        } else if (type === 'success') {
          messageBox.classList.add('bg-green-600', 'text-white');
        } else {
          messageBox.classList.add('bg-blue-600', 'text-white');
        }
        messageBox.classList.remove('translate-x-full'); // Show the message
        setTimeout(() => {
          messageBox.classList.add('translate-x-full'); // Hide after 3 seconds
        }, 3000);
      }
    };

    // Firebase Authentication Listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        window.userId = user.uid;
        window.loggedIn = true;
        window.chatCount = 0; // Reset chat count on successful login
        document.getElementById('login-popup').classList.remove('flex');
        document.getElementById('login-popup').classList.add('hidden');
        console.log("User signed in:", window.userId);

        // Listen for real-time chat updates
        const q = query(collection(db, `artifacts/${appId}/users/${window.userId}/chats`));
        onSnapshot(q, (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
              const chatMessage = change.doc.data();
              // Only display if it's a new message not already present in the chatbox
              // This is a simple deduplication; more robust might involve message IDs
              const existingMessages = Array.from(document.getElementById('chat-box').children).map(p => p.textContent);
              const messageText = `${chatMessage.role === 'user' ? 'You' : 'Martoo AI'}: ${chatMessage.text}`;
              if (!existingMessages.includes(messageText)) {
                displayMessage(chatMessage.text, chatMessage.role);
              }
            }
          });
          // After loading, remove the 'Typing...' if it was left from a previous session
          const lastChild = document.getElementById('chat-box').lastElementChild;
          if (lastChild && lastChild.innerHTML.includes('<em>Typing...</em>')) {
            lastChild.remove();
          }
          document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
        }, (error) => {
          console.error("Error listening to chat history:", error);
          showMessage("Error loading chat history.", 'error');
        });

      } else {
        window.loggedIn = false;
        window.userId = null;
        console.log("No user signed in.");
      }

      // If initial auth token is available, sign in. Otherwise, sign in anonymously.
      // This ensures we always have a userId, even if anonymous.
      if (!user) { // Only attempt sign-in if no user is already logged in
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
            console.log("Signed in with custom token.");
          } else {
            await signInAnonymously(auth);
            console.log("Signed in anonymously.");
          }
        } catch (error) {
          console.error("Firebase sign-in error:", error);
          showMessage("Failed to sign in. Please try again later.", 'error');
        }
      }
    });

    // Function to add a message to the chat box
    window.displayMessage = (text, sender) => {
      const chatBox = document.getElementById("chat-box");
      const messageElement = document.createElement("p");
      messageElement.classList.add('p-2', 'my-2', 'rounded-lg', 'max-w-xs', 'md:max-w-md'); // Tailwind classes for chat bubbles

      if (sender === "user") {
        messageElement.innerHTML = `<span class="font-semibold text-blue-400">You:</span> ${text}`;
        messageElement.classList.add('bg-blue-600', 'text-white', 'ml-auto'); // User messages align right
      } else {
        messageElement.innerHTML = `<span class="font-semibold text-green-400">Martoo AI:</span> ${text}`;
        messageElement.classList.add('bg-gray-700', 'text-white', 'mr-auto'); // AI messages align left
      }
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    // Save chat message to Firestore
    window.saveChatMessage = async (text, role) => {
      if (window.userId) {
        try {
          await addDoc(collection(db, `artifacts/${appId}/users/${window.userId}/chats`), {
            text: text,
            role: role,
            timestamp: serverTimestamp()
          });
          console.log("Chat message saved to Firestore.");
        } catch (e) {
          console.error("Error adding document: ", e);
          showMessage("Failed to save chat history.", 'error');
        }
      } else {
        console.warn("User not authenticated, skipping chat history save.");
      }
    };

    // Login functions
    window.loginUser = async () => {
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage("Logged in successfully!", 'success');
        // onAuthStateChanged will handle UI update
      } catch (error) {
        console.error("Login error:", error);
        showMessage("Login failed: " + error.message, 'error');
      }
    };

    window.googleSignIn = async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
        showMessage("Signed in with Google successfully!", 'success');
        // onAuthStateChanged will handle UI update
      } catch (error) {
        console.error("Google login error:", error);
        showMessage("Google login failed: " + error.message, 'error');
      }
    };

    // Other global functions
    window.toggleMenu = () => {
      document.getElementById("menu").classList.toggle("hidden");
    };

    window.sendMessage = async () => {
      const input = document.getElementById("user-input");
      const message = input.value.trim();
      const previewImg = document.getElementById('preview-img');
      const fileInput = document.getElementById('file-input');
      
      // If not logged in and past chat limit, show login popup
      if (!window.loggedIn && window.chatCount >= 5) {
        document.getElementById("login-popup").classList.remove('hidden');
        document.getElementById("login-popup").classList.add('flex');
        return;
      }

      if (!message && !fileInput.files[0]) {
        showMessage("Please enter a message or select an image.", 'info');
        return;
      }

      window.chatCount++;

      // Display user message
      displayMessage(message, "user");
      saveChatMessage(message, "user"); // Save user message immediately

      // Display loading indicator
      const loadingElement = document.createElement("p");
      loadingElement.innerHTML = `<span class="font-semibold text-green-400">Martoo AI:</span> <em class="typing-indicator">Typing...</em>`;
      loadingElement.classList.add('p-2', 'my-2', 'rounded-lg', 'max-w-xs', 'md:max-w-md', 'bg-gray-700', 'text-white', 'mr-auto');
      document.getElementById("chat-box").appendChild(loadingElement);
      document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;

      try {
        // --- Gemini API Call ---
        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: message }] });

        // If an image is selected, add it to the chat history for Gemini
        if (fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            const base64ImageData = e.target.result.split(',')[1]; // Get base64 part
            chatHistory[0].parts.push({
              inlineData: {
                mimeType: fileInput.files[0].type,
                data: base64ImageData
              }
            });
            await callGemini(chatHistory, loadingElement);
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          await callGemini(chatHistory, loadingElement);
        }

      } catch (err) {
        console.error("Error during AI communication:", err);
        loadingElement.innerHTML = `<span class="font-semibold text-green-400">Martoo AI:</span> ⚠️ Error: ${err.message || "Failed to get response."}`;
        saveChatMessage(loadingElement.textContent, "ai"); // Save error message
      } finally {
        input.value = "";
        fileInput.value = ''; // Clear file input
        previewImg.src = ''; // Clear image preview
        previewImg.classList.add('hidden'); // Hide preview
        document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
      }
    };

    // Helper function to make the Gemini API call
    async function callGemini(chatHistory, loadingElement) {
      const payload = { contents: chatHistory };
      const apiKey = ""; // Canvas environment will provide this API key
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();

      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const aiResponseText = result.candidates[0].content.parts[0].text;
        loadingElement.innerHTML = `<span class="font-semibold text-green-400">Martoo AI:</span> ${aiResponseText}`;
        saveChatMessage(aiResponseText, "ai"); // Save AI response
      } else {
        console.error("Unexpected Gemini API response structure:", result);
        loadingElement.innerHTML = `<span class="font-semibold text-green-400">Martoo AI:</span> ⚠️ No valid response from AI.`;
        saveChatMessage(loadingElement.textContent, "ai"); // Save error message
      }
    }

    // Speech Recognition
    window.startDictation = () => {
      if (!('webkitSpeechRecognition' in window)) {
        showMessage("Speech recognition is not supported in this browser.", 'error');
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById("user-input").value = transcript;
        sendMessage();
      };
      recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        showMessage("Speech error: " + event.error, 'error');
      };
      recognition.start();
    };

    // Event Listeners on window load
    window.onload = () => {
      // Restore chat from Firestore on auth state change (handled by onAuthStateChanged listener)
      // Display initial welcome message if chat box is empty (e.g., first time user or no history)
      if (document.getElementById("chat-box").children.length === 0) {
        displayMessage("Hello 👋 I’m here to help. Ask me anything!", "ai");
      }

      // Hide menu on navigation link click (for mobile)
      document.querySelectorAll("nav ul li a").forEach(link => {
        link.addEventListener("click", () => document.getElementById("menu").classList.add("hidden"));
      });

      // Send message on Enter key press
      document.getElementById("user-input").addEventListener("keydown", e => {
        if (e.key === "Enter") sendMessage();
      });

      // Image file input preview
      document.getElementById("file-input").addEventListener("change", e => {
        const file = e.target.files[0];
        const previewImg = document.getElementById("preview-img");
        if (file) {
          const reader = new FileReader();
          reader.onload = e => {
            previewImg.src = e.target.result;
            previewImg.classList.remove('hidden'); // Show preview
            previewImg.classList.add('block');
          };
          reader.readAsDataURL(file);
        } else {
          previewImg.src = ''; // Clear preview
          previewImg.classList.add('hidden'); // Hide preview
          previewImg.classList.remove('block');
        }
      });
    };
  </script>
</head>
<body class="flex flex-col min-h-screen bg-gray-900 text-white font-inter">
  <!-- Header -->
  <header class="bg-gray-800 p-4 shadow-md flex items-center justify-between z-10 sticky top-0">
    <h1 class="text-xl md:text-2xl font-bold text-teal-400">Martoo AI Assistant</h1>
    <div class="md:hidden">
      <button onclick="toggleMenu()" class="text-white text-2xl focus:outline-none">☰</button>
    </div>
    <nav class="hidden md:block">
      <ul id="menu" class="flex flex-col md:flex-row md:space-x-6 text-lg">
        <li><a href="#" class="hover:text-teal-400 transition-colors duration-200 p-2 rounded-md">Home</a></li>
        <li><a href="#" class="hover:text-teal-400 transition-colors duration-200 p-2 rounded-md">Blog</a></li>
        <li><a href="#" class="hover:text-teal-400 transition-colors duration-200 p-2 rounded-md">Services</a></li>
        <li><a href="#" class="hover:text-teal-400 transition-colors duration-200 p-2 rounded-md">Typing Assistant</a></li>
        <li><a href="#" class="hover:text-teal-400 transition-colors duration-200 p-2 rounded-md">About</a></li>
        <li><a href="#" class="hover:text-teal-400 transition-colors duration-200 p-2 rounded-md">Contact</a></li>
        <li><a href="#" class="hover:text-teal-400 transition-colors duration-200 p-2 rounded-md">Downloader</a></li>
      </ul>
    </nav>
  </header>

  <!-- Main Chat Content -->
  <main class="flex-grow flex flex-col items-center p-4">
    <div class="chat-container bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col w-full max-w-3xl h-[70vh] md:h-[80vh]">
      <!-- Chat Box -->
      <div id="chat-box" class="flex-grow overflow-y-auto p-3 mb-4 bg-gray-700 rounded-lg custom-scrollbar">
        <!-- Chat messages will be appended here -->
        <!-- User ID display for multi-user apps -->
        <p class="text-xs text-gray-400 text-right mb-2">
          Your User ID: <span id="display-user-id" class="font-mono break-all">Loading...</span>
        </p>
      </div>

      <!-- Chat Input -->
      <div class="chat-input flex flex-col md:flex-row gap-2">
        <input type="text" id="user-input" placeholder="Ask Martoo AI anything..." autocomplete="off"
               class="flex-grow p-3 rounded-lg border border-gray-600 bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-500"/>
        <input type="file" id="file-input" accept="image/*" class="hidden" />
        <label for="file-input" class="cursor-pointer bg-gray-600 hover:bg-gray-500 text-white p-3 rounded-lg transition-colors duration-200 flex items-center justify-center">
          <i class="fas fa-image"></i>
        </label>
        <button onclick="sendMessage()"
                class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-semibold transition-colors duration-200">
          Send
        </button>
        <button onclick="startDictation()"
                class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg font-semibold transition-colors duration-200">
          <i class="fas fa-microphone"></i>
        </button>
      </div>
      <!-- Image Preview -->
      <img id="preview-img" class="mt-2 hidden w-32 h-auto rounded-lg shadow-md border border-gray-600 object-cover" alt="Image Preview" />
    </div>
  </main>

  <!-- Login Popup (Custom Modal) -->
  <div id="login-popup" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[1001] items-center justify-center p-4">
    <div class="login-box bg-gray-800 p-8 rounded-xl shadow-2xl text-white w-full max-w-sm text-center border-2 border-teal-500">
      <h3 class="text-2xl font-bold mb-6 text-teal-400">Login to continue</h3>
      <input type="email" id="login-email" placeholder="Email"
             class="block w-full p-3 mb-4 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-500"/>
      <input type="password" id="login-password" placeholder="Password"
             class="block w-full p-3 mb-6 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-500"/>
      <button onclick="loginUser()"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-semibold transition-colors duration-200 mb-3">
        Login
      </button>
      <button onclick="googleSignIn()"
              class="w-full bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg font-semibold transition-colors duration-200 flex items-center justify-center gap-2">
        <i class="fab fa-google"></i> Login with Google
      </button>
      <button onclick="document.getElementById('login-popup').classList.add('hidden'); document.getElementById('login-popup').classList.remove('flex');"
              class="mt-4 text-sm text-gray-400 hover:text-gray-200 transition-colors duration-200">
        Maybe Later (Continue as Anonymous)
      </button>
    </div>
  </div>

  <!-- Custom Message Box (replaces alerts) -->
  <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-transform duration-300 transform translate-x-full">
    <!-- Messages will appear here -->
  </div>

  <!-- Footer -->
  <footer class="bg-gray-800 p-4 text-center text-gray-400 text-sm mt-auto">
    &copy; 2024–2025 | Martoo Tech Works. All rights reserved.
  </footer>
</body>
</html>
